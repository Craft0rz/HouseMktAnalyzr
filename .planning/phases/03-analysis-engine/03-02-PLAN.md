---
phase: 03-analysis-engine
plan: 02
type: execute
---

<objective>
Implement property ranking system for comparing and sorting investment opportunities.

Purpose: Rank and filter properties based on investment criteria. Enable quick identification of best opportunities from large listing sets.
Output: PropertyRanker class with sorting, filtering, and batch analysis.
</objective>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/03-analysis-engine/03-01-SUMMARY.md
@src/housemktanalyzr/models/property.py
@src/housemktanalyzr/analysis/calculator.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PropertyRanker class</name>
  <files>src/housemktanalyzr/analysis/ranker.py</files>
  <action>
    Create property ranking and filtering class:

    ```python
    class PropertyRanker:
        """Rank and filter properties by investment criteria."""

        def __init__(self, calculator: Optional[InvestmentCalculator] = None):
            self.calc = calculator or InvestmentCalculator()

        def analyze_batch(
            self, listings: list[PropertyListing]
        ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
            """Analyze multiple properties and return with metrics."""

        def rank_by_score(
            self, listings: list[PropertyListing]
        ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
            """Rank properties by investment score (highest first)."""

        def rank_by_cap_rate(
            self, listings: list[PropertyListing]
        ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
            """Rank by cap rate (highest first)."""

        def rank_by_cash_flow(
            self, listings: list[PropertyListing]
        ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
            """Rank by monthly cash flow (highest first)."""

        def filter_positive_cash_flow(
            self, listings: list[PropertyListing]
        ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
            """Filter to only positive cash flow properties."""
    ```
  </action>
  <verify>python -c "from housemktanalyzr.analysis.ranker import PropertyRanker; r = PropertyRanker(); print('PropertyRanker OK')"</verify>
  <done>PropertyRanker class created with ranking methods</done>
</task>

<task type="auto">
  <name>Task 2: Add filtering and criteria methods</name>
  <files>src/housemktanalyzr/analysis/ranker.py</files>
  <action>
    Add filtering by investment criteria:

    ```python
    def filter_by_criteria(
        self,
        listings: list[PropertyListing],
        min_cap_rate: Optional[float] = None,
        min_cash_flow: Optional[int] = None,
        max_price_per_unit: Optional[int] = None,
        min_score: Optional[float] = None,
        property_types: Optional[list[PropertyType]] = None,
    ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
        """Filter properties by multiple criteria."""

    def get_top_opportunities(
        self,
        listings: list[PropertyListing],
        n: int = 10,
        sort_by: str = "score",
    ) -> list[tuple[PropertyListing, InvestmentMetrics]]:
        """Get top N investment opportunities."""
    ```
  </action>
  <verify>python -c "
from housemktanalyzr.analysis.ranker import PropertyRanker
from housemktanalyzr.models.property import PropertyListing, PropertyType

r = PropertyRanker()
listings = [
    PropertyListing(id='1', source='test', address='A', city='Montreal',
        price=500000, property_type=PropertyType.DUPLEX,
        bedrooms=4, bathrooms=2, units=2, url='http://a'),
    PropertyListing(id='2', source='test', address='B', city='Montreal',
        price=600000, property_type=PropertyType.TRIPLEX,
        bedrooms=6, bathrooms=3, units=3, url='http://b'),
]
top = r.get_top_opportunities(listings, n=2)
print(f'Top 2: {[t[0].id for t in top]}')
"</verify>
  <done>Filtering and top opportunities methods work</done>
</task>

<task type="auto">
  <name>Task 3: Add summary report generation</name>
  <files>src/housemktanalyzr/analysis/ranker.py</files>
  <action>
    Add method to generate summary report:

    ```python
    def generate_report(
        self,
        listings: list[PropertyListing],
        top_n: int = 10,
    ) -> str:
        """Generate text summary report of top opportunities."""
    ```

    Report should include:
    - Total properties analyzed
    - Average/median metrics
    - Top N properties with key metrics
    - Formatted for terminal/text output
  </action>
  <verify>python -c "
from housemktanalyzr.analysis.ranker import PropertyRanker
from housemktanalyzr.models.property import PropertyListing, PropertyType

r = PropertyRanker()
listings = [
    PropertyListing(id='1', source='test', address='123 Test', city='Montreal',
        price=500000, property_type=PropertyType.DUPLEX,
        bedrooms=4, bathrooms=2, units=2, url='http://a'),
]
report = r.generate_report(listings, top_n=5)
print(report[:200])
"</verify>
  <done>Report generation produces formatted summary</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] PropertyRanker imports correctly
- [ ] Batch analysis works on multiple listings
- [ ] Ranking by score/cap_rate/cash_flow works
- [ ] Filtering by criteria works
- [ ] Report generation produces readable output
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Can rank 200+ properties quickly
- Phase 3 complete - ready for Phase 4 (Dashboard)
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-engine/03-02-SUMMARY.md`
</output>
