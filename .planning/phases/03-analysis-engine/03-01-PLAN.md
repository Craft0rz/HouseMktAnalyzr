---
phase: 03-analysis-engine
plan: 01
type: execute
---

<objective>
Implement investment metrics calculator for property analysis.

Purpose: Calculate key investment metrics (cap rate, GRM, cash-on-cash return, rental yield) that investors use to evaluate multi-family properties.
Output: InvestmentCalculator class with methods for all major investment metrics.
</objective>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/housemktanalyzr/models/property.py
@src/housemktanalyzr/enrichment/cmhc.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create InvestmentCalculator class</name>
  <files>src/housemktanalyzr/analysis/__init__.py, src/housemktanalyzr/analysis/calculator.py</files>
  <action>
    Create investment metrics calculator:

    ```python
    class InvestmentCalculator:
        """Calculate investment metrics for property analysis."""

        def __init__(self, cmhc_data: Optional[CMHCRentalData] = None):
            self.cmhc = cmhc_data or CMHCRentalData()

        def gross_rental_yield(self, price: int, annual_rent: int) -> float:
            """Annual rent / price * 100"""

        def cap_rate(self, price: int, noi: int) -> float:
            """NOI / price * 100 (Net Operating Income)"""

        def gross_rent_multiplier(self, price: int, annual_rent: int) -> float:
            """Price / annual rent (lower is better)"""

        def cash_on_cash_return(
            self, annual_cash_flow: int, total_cash_invested: int
        ) -> float:
            """Annual cash flow / cash invested * 100"""

        def estimate_noi(
            self, annual_rent: int, expense_ratio: float = 0.35
        ) -> int:
            """Estimate NOI using expense ratio (default 35%)"""

        def estimate_monthly_cash_flow(
            self, monthly_rent: int,
            monthly_mortgage: int,
            expense_ratio: float = 0.35,
        ) -> int:
            """Monthly rent - expenses - mortgage"""

        def estimate_rent_from_listing(
            self, listing: PropertyListing
        ) -> int:
            """Estimate rent using CMHC data or listing's gross_revenue"""
    ```

    Include realistic default expense ratios for Quebec multi-family:
    - Property taxes: ~1.0-1.5% of value
    - Insurance: ~0.3-0.5%
    - Maintenance: ~5-10% of rent
    - Vacancy: ~2-3%
    - Management: 0-8% (if self-managed vs property manager)
  </action>
  <verify>python -c "from housemktanalyzr.analysis import InvestmentCalculator; calc = InvestmentCalculator(); print(f'Cap rate test: {calc.cap_rate(500000, 25000):.1f}%')"</verify>
  <done>Calculator computes cap rate of 5.0% for $500k property with $25k NOI</done>
</task>

<task type="auto">
  <name>Task 2: Add mortgage calculation helpers</name>
  <files>src/housemktanalyzr/analysis/calculator.py</files>
  <action>
    Add mortgage payment calculation methods:

    ```python
    def calculate_mortgage_payment(
        self,
        principal: int,
        annual_rate: float,
        amortization_years: int = 25,
    ) -> int:
        """Calculate monthly mortgage payment."""

    def calculate_down_payment(
        self, price: int, down_payment_pct: float = 0.20
    ) -> int:
        """Calculate down payment amount."""

    def calculate_total_cash_needed(
        self,
        price: int,
        down_payment_pct: float = 0.20,
        closing_costs_pct: float = 0.03,
    ) -> int:
        """Total cash = down payment + closing costs."""
    ```

    Use standard Canadian mortgage formulas (monthly compounding).
    Default to 20% down (minimum for investment property in Canada).
  </action>
  <verify>python -c "from housemktanalyzr.analysis import InvestmentCalculator; calc = InvestmentCalculator(); pmt = calc.calculate_mortgage_payment(400000, 0.05); print(f'Monthly payment: ${pmt:,}')"</verify>
  <done>Mortgage payment calculation returns reasonable value (~$2,300 for $400k at 5%)</done>
</task>

<task type="auto">
  <name>Task 3: Create analyze_property method</name>
  <files>src/housemktanalyzr/analysis/calculator.py</files>
  <action>
    Add comprehensive property analysis method:

    ```python
    def analyze_property(
        self,
        listing: PropertyListing,
        down_payment_pct: float = 0.20,
        interest_rate: float = 0.05,
        expense_ratio: float = 0.35,
    ) -> InvestmentMetrics:
        """
        Full investment analysis for a property.

        Returns InvestmentMetrics with:
        - gross_rental_yield
        - cap_rate
        - price_per_unit
        - price_per_sqft
        - cash_flow_monthly
        - score (0-100)
        - score_breakdown
        """
    ```

    The method should:
    1. Estimate rent if not provided (using CMHC + bedrooms)
    2. Calculate all metrics
    3. Return populated InvestmentMetrics model
  </action>
  <verify>python -c "
from housemktanalyzr.analysis import InvestmentCalculator
from housemktanalyzr.models.property import PropertyListing, PropertyType

calc = InvestmentCalculator()
listing = PropertyListing(
    id='test', source='test', address='Test', city='Montreal',
    price=600000, property_type=PropertyType.TRIPLEX,
    bedrooms=6, bathrooms=3, units=3, url='http://test'
)
metrics = calc.analyze_property(listing)
print(f'Yield: {metrics.gross_rental_yield:.1f}%')
print(f'Cap rate: {metrics.cap_rate:.1f}%')
"</verify>
  <done>analyze_property returns complete InvestmentMetrics for a triplex</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] InvestmentCalculator imports correctly
- [ ] Cap rate calculation is accurate (NOI/price*100)
- [ ] Mortgage payment matches standard amortization
- [ ] analyze_property returns valid InvestmentMetrics
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Can analyze any PropertyListing and get investment metrics
- Ready for 03-02 (scoring algorithm)
</success_criteria>

<output>
After completion, create `.planning/phases/03-analysis-engine/03-01-SUMMARY.md`
</output>
