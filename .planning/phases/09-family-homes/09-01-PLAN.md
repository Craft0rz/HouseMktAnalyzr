---
phase: 09-family-homes
type: execute
---

<objective>
Create the Family Home Scoring engine that evaluates houses for family livability instead of investment returns.

Purpose: Houses (property_type=HOUSE) need a fundamentally different scoring model. Investment metrics (cap rate, cash flow, price-per-unit) are irrelevant for owner-occupied family homes. Instead, families care about livability, value, and space/comfort.
Output: FamilyHomeMetrics model, FamilyHomeScorer class, and /api/analysis/family-score API endpoint.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@src/housemktanalyzr/models/property.py
@src/housemktanalyzr/analysis/calculator.py
@src/housemktanalyzr/analysis/ranker.py
@backend/app/routers/analysis.py
@backend/app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FamilyHomeMetrics model</name>
  <files>src/housemktanalyzr/models/property.py</files>
  <action>
Add a new Pydantic model `FamilyHomeMetrics` alongside the existing `InvestmentMetrics`. Fields:

```python
class FamilyHomeMetrics(BaseModel):
    property_id: str
    purchase_price: int

    # Overall score (0-100)
    family_score: float = Field(ge=0, le=100)
    score_breakdown: dict[str, float] = Field(default_factory=dict)

    # Livability Pillar (0-40)
    livability_score: float = Field(ge=0, le=40)
    walk_score_pts: float | None = None       # 0-8 from walk_score
    transit_score_pts: float | None = None     # 0-8 from transit_score
    safety_pts: float | None = None            # 0-8 from safety_score
    school_proximity_pts: float | None = None  # 0-10 (future: geo data)
    parks_pts: float | None = None             # 0-6 (future: geo data)

    # Value Pillar (0-35)
    value_score: float = Field(ge=0, le=35)
    price_vs_assessment_pts: float | None = None  # 0-10
    price_per_sqft: float | None = None
    price_per_sqft_pts: float | None = None       # 0-8
    monthly_cost_estimate: int | None = None      # mortgage + taxes + insurance + energy
    affordability_pts: float | None = None        # 0-10
    market_trajectory_pts: float | None = None    # 0-7 (future: price history trend)

    # Space & Comfort Pillar (0-25)
    space_score: float = Field(ge=0, le=25)
    lot_size_pts: float | None = None         # 0-8
    bedroom_pts: float | None = None          # 0-7
    condition_pts: float | None = None        # 0-6 from condition_score
    age_pts: float | None = None              # 0-4 from year_built

    # Cost of ownership breakdown
    estimated_monthly_mortgage: int | None = None
    estimated_monthly_taxes: int | None = None
    estimated_annual_energy: int | None = None
    estimated_annual_insurance: int | None = None
    welcome_tax: int | None = None
    total_cash_needed: int | None = None

    # Risk flags
    flood_zone: bool | None = None            # future: CEHQ API
    contaminated_nearby: bool | None = None   # future: ESRI API
```

Do NOT modify InvestmentMetrics or any existing model. This is a new, separate model for houses only.
  </action>
  <verify>python -c "import ast; ast.parse(open('src/housemktanalyzr/models/property.py').read())"</verify>
  <done>FamilyHomeMetrics model exists in property.py, passes syntax check, does not break existing models</done>
</task>

<task type="auto">
  <name>Task 2: Create FamilyHomeScorer class</name>
  <files>src/housemktanalyzr/analysis/family_scorer.py</files>
  <action>
Create a new file `family_scorer.py` with `FamilyHomeScorer` class. This is the core scoring engine.

**Livability Pillar (0-40 pts):**

Walk Score (0-8 pts):
- walk_score >= 70 → 8, >= 50 → 5, >= 30 → 3, < 30 → 0

Transit Score (0-8 pts):
- transit_score >= 70 → 8, >= 50 → 5, >= 30 → 3, < 30 → 0

Safety (0-8 pts):
- safety_score >= 7 → 8, >= 5 → 5, >= 3 → 3, < 3 → 0

School Proximity (0-10 pts):
- For now, return None (placeholder for 09-03 geo data enrichment)
- When available: nearest_elementary <= 500m → 10, <= 1km → 7, <= 2km → 4, > 2km → 0

Parks Nearby (0-6 pts):
- For now, return None (placeholder for 09-03 geo data enrichment)

**Value Pillar (0-35 pts):**

Price vs Municipal Assessment (0-10 pts):
- If municipal_assessment available:
  - ratio = price / assessment
  - ratio <= 0.90 → 10 (buying below assessment = great deal)
  - ratio <= 1.00 → 8
  - ratio <= 1.10 → 5
  - ratio <= 1.25 → 2
  - ratio > 1.25 → 0

Price per sqft (0-8 pts):
- Calculate price_per_sqft from listing.price / listing.sqft
- For Quebec houses: < $200/sqft → 8, < $300 → 6, < $400 → 4, < $500 → 2, >= $500 → 0

Affordability / Monthly Cost (0-10 pts):
- Estimate total monthly cost = mortgage + taxes/12 + insurance/12 + energy/12
- Use same Canadian mortgage formula from calculator.py (semi-annual compounding)
- Default: 5% down for owner-occupied (CMHC insured), 5% rate, 25yr amortization
- CMHC insurance: price <= 500k → 4.0%, 500k-999k → tiered (first 500k at 4%, rest at depends), max insurable 1.499M
- Simplified: use 3.5% CMHC premium on full mortgage amount
- Monthly cost < $2,500 → 10, < $3,000 → 8, < $3,500 → 6, < $4,000 → 4, < $5,000 → 2, >= $5,000 → 0

Market Trajectory (0-7 pts):
- For now, return None (placeholder — would use price history trend)

**Space & Comfort Pillar (0-25 pts):**

Lot Size (0-8 pts):
- lot_sqft >= 8000 → 8, >= 6000 → 6, >= 4000 → 4, >= 2500 → 2, < 2500 → 0

Bedrooms (0-7 pts):
- bedrooms >= 4 → 7, == 3 → 5, == 2 → 2, < 2 → 0

Condition (0-6 pts):
- condition_score >= 8 → 6, >= 6 → 4, >= 4 → 2, < 4 → 0

Property Age (0-4 pts):
- If year_built available: age = current_year - year_built
- age <= 10 → 4, <= 25 → 3, <= 50 → 2, <= 75 → 1, > 75 → 0

**Cost of Ownership calculations:**

Welcome Tax (Quebec mutation tax):
- Standard brackets: first $58,900 → 0.5%, next ($58,900–$294,600) → 1.0%, next ($294,600–$500,000) → 1.5%, over $500,000 → 2.0%
- Montreal has extra bracket: over $500,000 → 2.0%, over $1,000,000 → 2.5%, over $2,000,000 → 3.0%
- For simplicity, use standard Quebec brackets (Montreal detection can be added later)

Energy estimate (annual):
- Based on year_built and sqft:
  - Pre-1970: $0.045/sqft/month (poorly insulated)
  - 1970-1990: $0.035/sqft/month
  - 1990-2010: $0.028/sqft/month
  - Post-2010: $0.022/sqft/month
  - Fallback (no year): $0.035/sqft/month

Insurance estimate (annual):
- Based on price: ~0.35% of property value (Quebec average for houses)

Class interface:
```python
class FamilyHomeScorer:
    def __init__(self, down_payment_pct=0.05, interest_rate=0.05, amortization_years=25):
        ...

    def score_property(self, listing: PropertyListing, safety_score: float | None = None,
                       school_distance_m: float | None = None,
                       park_count_1km: int | None = None,
                       flood_zone: bool | None = None,
                       contaminated_nearby: bool | None = None) -> FamilyHomeMetrics:
        ...
```

Import and use the mortgage calculation from calculator.py's `calculate_mortgage_payment` (semi-annual compounding). Do NOT duplicate the formula.
  </action>
  <verify>python -c "import ast; ast.parse(open('src/housemktanalyzr/analysis/family_scorer.py').read())"</verify>
  <done>FamilyHomeScorer class exists with score_property() method, all three pillars implemented, cost of ownership calculations correct</done>
</task>

<task type="auto">
  <name>Task 3: Add family scoring API endpoint</name>
  <files>backend/app/routers/analysis.py, backend/app/main.py</files>
  <action>
Add two new endpoints to the existing analysis.py router:

1. `POST /api/analysis/family-score` — Score a single house listing
   - Request body: same AnalyzeRequest (reuse it) but with a PropertyListing where property_type=HOUSE
   - Response: FamilyHomeMetrics
   - Fetch location data (reuse _fetch_location_data for safety_score)
   - Call FamilyHomeScorer.score_property()

2. `POST /api/analysis/family-score-batch` — Score multiple houses
   - Request body: AnalyzeBatchRequest (reuse)
   - Response: new FamilyBatchResponse with results list and summary
   - Filter to only HOUSE type listings
   - Batch-fetch location data (same pattern as existing analyze_batch)
   - Return results sorted by family_score descending

Add response models:
```python
class HouseWithScore(BaseModel):
    listing: PropertyListing
    family_metrics: FamilyHomeMetrics

class FamilyBatchResponse(BaseModel):
    results: list[HouseWithScore]
    count: int
    summary: dict
```

Add FamilyHomeMetrics import to analysis.py. Do NOT modify existing endpoints.
  </action>
  <verify>python -c "import ast; ast.parse(open('backend/app/routers/analysis.py').read())"</verify>
  <done>Two new endpoints exist, response models defined, syntax check passes, existing endpoints unchanged</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `python -c "import ast; ast.parse(open('src/housemktanalyzr/models/property.py').read())"` passes
- [ ] `python -c "import ast; ast.parse(open('src/housemktanalyzr/analysis/family_scorer.py').read())"` passes
- [ ] `python -c "import ast; ast.parse(open('backend/app/routers/analysis.py').read())"` passes
- [ ] FamilyHomeMetrics model has all three pillar scores and cost breakdown fields
- [ ] FamilyHomeScorer produces scores 0-100 with correct pillar weights (40+35+25)
- [ ] Welcome tax calculation uses correct Quebec brackets
- [ ] Mortgage uses Canadian semi-annual compounding (reuses calculator.py)
- [ ] Existing investment scoring endpoints are unchanged
</verification>

<success_criteria>
- FamilyHomeMetrics model defined with all fields
- FamilyHomeScorer scores houses on 3 pillars: Livability (40), Value (35), Space & Comfort (25)
- Cost of ownership includes mortgage, taxes, energy, insurance, welcome tax
- API endpoints /family-score and /family-score-batch work
- Placeholder hooks exist for future geo data (schools, parks, flood zones)
- No changes to existing investment scoring
</success_criteria>

<output>
After completion, create `.planning/phases/09-family-homes/09-01-SUMMARY.md`
</output>
