---
phase: 08-map-view
plan: 01
type: execute
---

<objective>
Add an interactive map view to the search page showing property pins colored by investment score.

Purpose: Investors need spatial context — seeing where deals cluster, which neighbourhoods have opportunities, and how properties relate geographically. The table view lacks this entirely.
Output: A toggle between Table and Map views on the search page. Map shows all results as colored markers with popups containing key metrics. Clicking a marker opens the PropertyDetail sheet.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@frontend/src/app/search/page.tsx
@frontend/src/components/PropertyTable.tsx
@frontend/src/lib/types.ts
@frontend/src/i18n/en.json
@frontend/src/i18n/fr.json
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Leaflet dependencies and configure CSS</name>
  <files>frontend/package.json</files>
  <action>
    Run `npm install leaflet react-leaflet` and `npm install -D @types/leaflet` in the frontend directory.

    Import Leaflet CSS globally. Add `import 'leaflet/dist/leaflet.css';` to `frontend/src/app/layout.tsx` at the top of the imports.

    IMPORTANT: Do NOT import leaflet JS directly at module level in any component — Leaflet requires `window` and will crash Next.js SSR. The MapContainer from react-leaflet handles this internally, but the component that uses it must be loaded via `next/dynamic` with `{ ssr: false }`.
  </action>
  <verify>`cd frontend && npx tsc --noEmit` passes. `npm ls leaflet react-leaflet` shows both installed.</verify>
  <done>leaflet, react-leaflet, @types/leaflet installed. Leaflet CSS imported in layout. No build errors.</done>
</task>

<task type="auto">
  <name>Task 2: Create PropertyMap component</name>
  <files>frontend/src/components/PropertyMap.tsx</files>
  <action>
    Create a new `PropertyMap.tsx` component. It receives the same data as PropertyTable:
    - `data: PropertyWithMetrics[]` — the filtered property list
    - `onMarkerClick: (property: PropertyWithMetrics) => void` — callback when a marker is clicked (opens detail sheet)
    - `lifecycle?: LifecycleMap` — for days-on-market badges
    - `priceChanges?: PriceChangeMap` — for price drop indicators

    Implementation:
    1. Use `MapContainer` + `TileLayer` + `Marker` + `Popup` from react-leaflet.
    2. TileLayer: Use OpenStreetMap tiles (`https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png`) — free, no API key needed.
    3. Default center: Montreal (45.5017, -73.5673), zoom 10. Auto-fit bounds to markers using `useMap()` hook + `fitBounds()` when data changes. If no markers have valid coords, keep default center.
    4. Markers: Filter to only properties with non-null lat/lng. Use Leaflet `divIcon` for custom colored circle markers (avoids the broken default marker icon issue in bundled Leaflet). Color by score: green (>=70), yellow (50-69), red (<50). Size: 24px circle.
    5. Popup content: Show address, price (formatted), score badge, cap rate, property type. Keep it compact (3-4 lines). Add a "View Details" button/link that calls `onMarkerClick`.
    6. Style: Match the app's design system. Use Tailwind classes inside popups where possible.

    IMPORTANT: Use `divIcon` with inline SVG or HTML for markers — do NOT use the default Leaflet icon which requires image files that break with bundlers. The divIcon approach is self-contained.

    IMPORTANT: Skip properties where latitude or longitude is null. Some listings may not have been geocoded yet.
  </action>
  <verify>`npx tsc --noEmit` passes. Component exports correctly. No SSR-related imports at top level.</verify>
  <done>PropertyMap component renders a Leaflet map with score-colored markers and info popups. Only shows geocoded properties. Clicking popup button triggers onMarkerClick callback.</done>
</task>

<task type="auto">
  <name>Task 3: Add Table/Map toggle to search page</name>
  <files>frontend/src/app/search/page.tsx, frontend/src/i18n/en.json, frontend/src/i18n/fr.json</files>
  <action>
    1. In search/page.tsx, add a `viewMode` state: `useState<'table' | 'map'>('table')`.

    2. Import PropertyMap dynamically to avoid SSR issues:
       ```typescript
       import dynamic from 'next/dynamic';
       const PropertyMap = dynamic(() => import('@/components/PropertyMap').then(m => m.PropertyMap), { ssr: false });
       ```

    3. Add toggle buttons in the results header area (near the status filter buttons, line ~186-198). Use two icon buttons or a segmented control:
       - Table icon (from lucide-react: `List` or `Table2`)
       - Map icon (from lucide-react: `Map`)
       Style: Similar to the status filter buttons. Active state uses `variant="default"`, inactive uses `variant="outline"`.

    4. Conditionally render PropertyTable or PropertyMap based on viewMode:
       - When `viewMode === 'table'`: render PropertyTable as before
       - When `viewMode === 'map'`: render PropertyMap with the same filtered data, passing `onRowClick` as `onMarkerClick`
       - Map should get a reasonable height: `h-[600px]` or similar

    5. Pass lifecycle and priceChanges maps to PropertyMap so it can show badges in popups.

    6. Add i18n keys to both en.json and fr.json:
       - `"search.tableView": "Table"` / `"search.tableView": "Tableau"`
       - `"search.mapView": "Map"` / `"search.mapView": "Carte"`
       - `"search.viewDetails": "View Details"` / `"search.viewDetails": "Voir les détails"`
       - `"search.noGeocodedListings": "No geocoded listings to display on map"` / `"search.noGeocodedListings": "Aucune propriété géocodée à afficher sur la carte"`

    7. When map view is active and no properties have lat/lng, show a message instead of an empty map.
  </action>
  <verify>`npx tsc --noEmit` passes. `npm run build` succeeds. Search page renders without errors in both table and map modes.</verify>
  <done>Search page has a Table/Map toggle. Table view works exactly as before. Map view shows all geocoded results as colored markers with popups. Clicking a marker opens the PropertyDetail sheet. i18n keys added for both languages.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `cd frontend && npx tsc --noEmit` passes with no errors
- [ ] `cd frontend && npm run build` succeeds
- [ ] Leaflet CSS loads (no unstyled map tiles)
- [ ] Map centers on Montreal by default, auto-fits to markers when data loads
- [ ] Markers are colored by score (green/yellow/red)
- [ ] Popups show address, price, score, cap rate
- [ ] Clicking popup "View Details" opens PropertyDetail sheet
- [ ] Toggle switches cleanly between table and map views
- [ ] Properties without lat/lng are skipped (no errors)
- [ ] i18n keys exist in both en.json and fr.json
</verification>

<success_criteria>
- All 3 tasks completed
- All verification checks pass
- No TypeScript or build errors introduced
- Map view is fully functional with score-colored markers
- Toggle between table/map works seamlessly
- Both English and French labels present
</success_criteria>

<output>
After completion, create `.planning/phases/08-map-view/08-01-SUMMARY.md`
</output>
