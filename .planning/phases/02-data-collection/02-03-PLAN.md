---
phase: 02-data-collection
plan: 03
type: execute
---

<objective>
Implement supplementary data sources for rental estimates and property assessments, plus a storage layer for caching.

Purpose: Enrich property data with rental income estimates (CMHC) and assessment values (Quebec open data). Add persistence layer for caching fetched properties.
Output: CMHCRentalData loader, QuebecAssessmentData loader, SQLite storage layer.
</objective>

<execution_context>
@~/.claude/skills/create-plans/workflows/execute-phase.md
@~/.claude/skills/create-plans/templates/summary.md
</execution_context>

<context>
@.planning/BRIEF.md
@.planning/ROADMAP.md
@.planning/phases/02-data-collection/FINDINGS.md
@.planning/phases/02-data-collection/02-02-SUMMARY.md
@src/housemktanalyzr/models/property.py
@src/housemktanalyzr/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement CMHC rental data loader</name>
  <files>src/housemktanalyzr/enrichment/__init__.py, src/housemktanalyzr/enrichment/cmhc.py</files>
  <action>
    Create loader for CMHC (Canada Mortgage and Housing Corporation) rental data:

    Data source: https://www03.cmhc-schl.gc.ca/hmip-pimh/

    CMHCRentalData class:
    - Download/cache CMHC rental market data for Greater Montreal
    - Parse average rents by: zone, bedroom count, building type
    - Provide lookup method: `get_estimated_rent(city, bedrooms, property_type) -> int`

    Data structure:
    ```python
    # Rental rates by area and bedroom count
    MONTREAL_RENTAL_DATA = {
        "montreal": {1: 1200, 2: 1500, 3: 1800, 4: 2100},
        "laval": {1: 1100, 2: 1400, 3: 1700, 4: 2000},
        "longueuil": {1: 1050, 2: 1350, 3: 1650, 4: 1950},
        # ... more zones
    }
    ```

    For MVP: hardcode recent CMHC data (can automate download later).
    Include data source URL and date in comments.
  </action>
  <verify>python -c "from housemktanalyzr.enrichment.cmhc import CMHCRentalData; r = CMHCRentalData(); print(f'Montreal 3br: ${r.get_estimated_rent(\"montreal\", 3)}')"</verify>
  <done>CMHC loader returns realistic rental estimates for Montreal area</done>
</task>

<task type="auto">
  <name>Task 2: Implement Quebec assessment data loader</name>
  <files>src/housemktanalyzr/enrichment/assessment.py</files>
  <action>
    Create loader for Quebec municipal assessment rolls:

    Data source: https://open.canada.ca/data/en/dataset/061c8cb7-ca4e-45be-a990-61fce7e7d2dc

    QuebecAssessmentData class:
    - Parse XML assessment files for Montreal-area municipalities
    - Extract: assessment value, land value, building value, lot size, building characteristics
    - Provide lookup by address or cadastral number

    For MVP:
    - Support Montreal (largest file)
    - Document how to add other municipalities
    - Handle missing data gracefully

    Note: XML files are large - implement lazy loading and caching.
  </action>
  <verify>python -c "from housemktanalyzr.enrichment.assessment import QuebecAssessmentData; print('Assessment loader OK')"</verify>
  <done>Assessment loader can be instantiated, documents data format</done>
</task>

<task type="auto">
  <name>Task 3: Create storage layer for property caching</name>
  <files>src/housemktanalyzr/storage/__init__.py, src/housemktanalyzr/storage/cache.py</files>
  <action>
    Create SQLite-based storage for caching fetched properties:

    PropertyCache class:
    - Store PropertyListing objects with fetch timestamp
    - Query by: region, price range, property type, date range
    - TTL-based expiration (configurable, default 24 hours)
    - Deduplication by listing ID + source

    Schema:
    ```sql
    CREATE TABLE properties (
        id TEXT PRIMARY KEY,  -- source:listing_id
        source TEXT NOT NULL,
        data JSON NOT NULL,   -- serialized PropertyListing
        fetched_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        expires_at TIMESTAMP
    );
    CREATE INDEX idx_source ON properties(source);
    CREATE INDEX idx_expires ON properties(expires_at);
    ```

    Methods:
    - save(listing: PropertyListing) -> None
    - save_batch(listings: List[PropertyListing]) -> None
    - get(listing_id: str, source: str) -> Optional[PropertyListing]
    - query(region: str, ...) -> List[PropertyListing]
    - prune_expired() -> int  # returns count deleted

    Use config.cache_dir for database location.
  </action>
  <verify>python -c "from housemktanalyzr.storage import PropertyCache; c = PropertyCache(); print(f'Cache at: {c.db_path}')"</verify>
  <done>SQLite cache works, can save and retrieve PropertyListing objects</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] All enrichment modules import correctly
- [ ] CMHC rental lookup returns reasonable values
- [ ] PropertyCache can save/load PropertyListing objects
- [ ] Cache respects TTL configuration
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Properties can be enriched with rental estimates
- Fetched data persists between runs
- Phase 2 complete - ready for Phase 3 (Analysis Engine)
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-collection/02-03-SUMMARY.md`
</output>
