# TO-DOS

## Verify Cash Flow Alignment After Mortgage Fix - 2026-02-09 08:12

- **Verify list vs detail cash flow match** - Confirm the mortgage formula fix produces matching cash flow values between the property list and detail panel. **Problem:** The detail panel was calculating mortgage payments using US-style monthly compounding and 25-year amortization, while the backend used Canadian semi-annual compounding and 30-year amortization. This caused the "Cash flow" in the list (from `metrics.cash_flow_monthly`) to differ from the "Net Monthly Cash Flow" in the detail panel. Fix applied: aligned detail panel to use Canadian compounding and 30yr amortization. Also fixed a second inline mortgage calculation in the Market Context card and updated en/fr i18n strings from "25yr" to "30yr". **Files:** `frontend/src/components/PropertyDetail.tsx:269-279,1024-1029`, `frontend/src/i18n/en.json:440`, `frontend/src/i18n/fr.json:440`, `src/housemktanalyzr/analysis/calculator.py:254-288` (backend reference). **Solution:** Test with a few properties and compare `metrics.cash_flow_monthly` from the API to the detail panel's computed `netCashFlow`. Minor rounding differences are expected (backend uses `int(math.ceil())`) but values should be within a few dollars.

## Change "New" Threshold from 7 Days to 48 Hours - 2026-02-10 19:30

- **Update "New" listing threshold to 48h** - Change the "New" property filter/badge from ≤7 days to ≤48 hours (2 days) on market. **Problem:** The current 7-day window is too wide for the "New" badge — properties listed almost a week ago shouldn't be considered new. A 48-hour threshold better reflects genuinely fresh listings. **Files:** `frontend/src/components/PropertyTable.tsx:90-91` (filter logic: `lc.days_on_market <= 7` → `<= 2`), `frontend/src/i18n/en.json:135` (label: `"New (≤7d)"` → `"New (≤48h)"`), `frontend/src/i18n/fr.json:135` (French equivalent label). **Solution:** Change the `days_on_market <= 7` comparison to `<= 2` in the `'new'` filter case. Update i18n labels in both en.json and fr.json to reflect "≤48h" instead of "≤7d".

## Add Editable Interest Rate and Down Payment - 2026-02-10 20:15

- **Add user-configurable interest rate and down payment to PropertyDetail** - Allow users to adjust interest rate and down payment percentage directly in the property detail panel instead of using hardcoded 5% / 20% defaults. **Problem:** The Mortgage Estimate and Cash Flow cards in PropertyDetail hardcode `downPaymentPct = 0.20` and `interestRate = 0.05` (line 269-273). Users can't explore "what if" scenarios without navigating to the separate Calculator page. The backend API already accepts these as parameters. **Files:** `frontend/src/components/PropertyDetail.tsx:269-279` (hardcoded constants → state variables with inline inputs), `frontend/src/components/PropertyDetail.tsx:609-640` (Mortgage Estimate card — add input controls here), `frontend/src/app/calculator/page.tsx:14-28` (existing editable pattern to replicate). **Solution:** Replace the hardcoded `downPaymentPct` and `interestRate` with `useState` hooks initialized to 0.20 / 0.05. Add two small number inputs (or sliders) inside the Mortgage Estimate card header or above the grid. All downstream values (downPayment, principal, monthlyMortgage, netCashFlow) already derive from these — they'll recompute automatically on change. No backend changes needed since the calculation is client-side.

## Fix Safety & Development for Non-Montreal Cities - 2026-02-10 20:15

- **Fix neighbourhood data lookup returning wrong borough for cities outside Montreal** - Properties in Longueuil, Quebec City, Sherbrooke, etc. incorrectly display Montreal borough data (e.g., Longueuil shows Ahuntsic-Cartierville stats). **Problem:** The frontend sends raw `listing.city` as the borough name (line 233: `property.listing.city || 'Montreal'`). The backend `get_neighbourhood_stats_for_borough()` does an exact match first, and when that fails (Longueuil is not a Montreal borough), it falls back to a dangerous `LIKE '%longueuil%'` partial match (db.py line 1282) which returns the first random Montreal borough match. The `resolve_borough()` function in `geo_mapping.py` exists to handle this correctly but is never called in the market API flow. **Files:** `frontend/src/components/PropertyDetail.tsx:232-237` (sends raw city, no postal code), `backend/app/routers/market.py:608-738` (neighbourhood endpoint — doesn't call `resolve_borough()`), `backend/app/db.py:1264-1288` (dangerous LIKE fallback), `backend/app/geo_mapping.py:230-259` (`resolve_borough()` — exists but unused in this flow). **Solution:** (1) Pass postal code from frontend alongside city. (2) Call `resolve_borough(city, postal_code)` in the market.py endpoint before querying DB. (3) Remove or tighten the LIKE fallback in db.py to prevent false matches. (4) Return null/empty when no valid borough match exists instead of wrong data.


